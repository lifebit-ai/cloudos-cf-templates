Description:
  Creates a stack that provisions an IAM role or user, analyses and fsx security groups used by the Lifebit workspace
  to perform all actions related to EMR, Batch, FSx services and instance roles.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Workspace role/user"
        Parameters:
          - ResourceType
          - IamRoleOrUserName
          - ExternallyManagedNetwork
          - TrustedAccountId
      - Label:
          default: "Additional Roles"
        Parameters:
          - ShouldCreateBatchServiceRole
          - ShouldCreateEMRServiceRole
      - Label:
          default: "Additional Security Groups"
        Parameters:
          - VpcId
          - ShouldCreateAnalysesSecurityGroup
          - ShouldCreateFsxSecurityGroup

Parameters:
  ResourceType:
    Type: String
    Default: Role
    Description: Would you like to link your account using an IAM Role or IAM User? We recommend selecting Role.
    AllowedValues:
      - User
      - Role

  IamRoleOrUserName:
    Type: String
    Default: lifebit-platform
    Description: The name of the workspace role/user. We recommend using "lifebit-platform".

  ExternallyManagedNetwork:
    Type: String
    Default: No
    Description: Have you set up your own network for the Lifebit Platform to use?
    AllowedValues:
      - Yes
      - No

  ShouldCreateBatchServiceRole:
    Type: String
    Default: Yes
    Description: Should the template set up an ancillary Batch role required for the workspace? Set as true if this role has not been created previously in your account.
    AllowedValues:
      - Yes
      - No

  ShouldCreateEMRServiceRole:
    Type: String
    Default: Yes
    Description: Should the template set up an ancillary EMR role required for the workspace? Set as true if this role has not been created previously in your account.
    AllowedValues:
      - Yes
      - No

  TrustedAccountId:
    Type: String
    Default: ""
    Description: Account to be trusted in case the role is selected. Leave this as-is if you use Lifebit CloudOS (cloudos.lifebit.ai).

  VpcId:
    Type: AWS::EC2::VPC::Id
    Default: ""
    Description: Vpc ID to use for security groups in case we need to create any of the security groups.

  ShouldCreateAnalysesSecurityGroup:
    Type: String
    Default: Yes
    Description: Should the template set up an analyses security group required for the workspace? Set as true if this security has not been created previously in your account.
    AllowedValues:
      - Yes
      - No

  ShouldCreateFsxSecurityGroup:
    Type: String
    Default: Yes
    Description: Should the template set up an fsx security group required for the workspace? Set as true if this security has not been created previously in your account.
    AllowedValues:
      - Yes
      - No

Conditions:
  UseRole: !Equals [!Ref ResourceType, "Role"]
  UseUser: !Equals [!Ref ResourceType, "User"]
  UseExternallyManagedNetwork: !Equals [!Ref ExternallyManagedNetwork, "true"]
  UseCreateBatchServiceRole: !Equals [!Ref ShouldCreateBatchServiceRole, "true"]
  UseCreateEMRServiceRole: !Equals [!Ref ShouldCreateEMRServiceRole, "true"]
  EmptyTrustedAccountId: !Equals [!Ref TrustedAccountId, ""]
  ShouldCreateAndAllowInstanceRoles:
    !Equals [!Ref TrustedAccountId, "021577063369"]
  CreateAnalysesSecurityGroup: !Equals [!Ref ShouldCreateAnalysesSecurityGroup, "true"]
  CreateFsxSecurityGroup: !Equals [!Ref ShouldCreateFsxSecurityGroup, "true"]

Resources:
  LifebitWorkspaceRole:
    Type: AWS::IAM::Role
    Condition: UseRole
    Properties:
      RoleName: !Ref IamRoleOrUserName
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub
                - arn:aws:iam::${TrustedAccountIdToUse}:root
                - TrustedAccountIdToUse:
                    !If [
                      EmptyTrustedAccountId,
                      "209235234270",
                      !Ref TrustedAccountId,
                    ]
            Action:
              - sts:AssumeRole
              - sts:TagSession
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole

  LifebitWorkspaceInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Condition: UseRole
    Properties:
      Roles:
        - !Ref LifebitWorkspaceRole
      InstanceProfileName: !Ref LifebitWorkspaceRole

  LifebitWorkspaceUser:
    Type: AWS::IAM::User
    Condition: UseUser
    Properties:
      UserName: !Ref IamRoleOrUserName

  LifebitWorkspaceUserKeys:
    Type: AWS::IAM::AccessKey
    Condition: UseUser
    DependsOn: LifebitWorkspaceUser
    Properties:
      UserName: !Ref IamRoleOrUserName

  LifebitWorkspaceUserSecret:
    Type: AWS::SecretsManager::Secret
    Condition: UseUser
    DependsOn: LifebitWorkspaceUserKeys
    Properties:
      Name: !Sub /lifebit/credentials/${IamRoleOrUserName}
      SecretString: !GetAtt [LifebitWorkspaceUserKeys, SecretAccessKey]

  LifebitWorkspacePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName:
        !Join ["-", [!Ref IamRoleOrUserName, "LifebitWorkspacePolicy"]]
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - ec2:DescribeAvailabilityZones
              - ec2:RunInstances
              - ec2:DescribeInstanceTypeOfferings
              - ec2:TerminateInstances
              - ec2:DescribeInstances
              - ec2:DescribeInstanceStatus
              - ec2:CreateLaunchTemplate
              - ec2:CreateLaunchTemplateVersion
              - ec2:DeleteLaunchTemplate
              - ec2:DeleteLaunchTemplateVersions
              - ec2:DescribeLaunchTemplates
              - ec2:CreateSnapshot
              - ec2:RegisterImage
              - ec2:DescribeImages
              - ec2:DescribeSnapshots
              - ec2:DeleteSnapshot
              - ec2:DeregisterImage
              - ec2:RequestSpotFleet
              - ec2:DescribeSpotFleetInstances
              - ec2:CancelSpotFleetRequests
              - ec2:CreateTags
              - ec2:DescribeVolumes
              - ec2:DescribeSecurityGroups
              - ec2:AllocateAddress
              - ec2:CreateInternetGateway
              - ec2:AttachInternetGateway
              - ec2:DescribeInternetGateways
              - ec2:CreateNatGateway
              - ec2:DescribeNatGateways
              - ec2:CreateVpc
              - ec2:DescribeVpcs
              - ec2:DescribeVpcAttribute
              - ec2:ModifyVpcAttribute
              - ec2:DescribeRouteTables
              - ec2:CreateRouteTable
              - ec2:CreateRoute
              - ec2:AssociateRouteTable
              - ec2:CreateSubnet
              - ec2:ModifySubnetAttribute
              - ec2:DescribeSubnets
              - ec2:DescribeRegions
              - ec2:DescribeSpotPriceHistory
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:DescribeInstanceTypes
              - ec2:ModifyVolume
              - ec2:DescribeVolumesModifications
              - ec2:DescribeInstanceAttribute
              - ec2:CreateSecurityGroup
              - ec2:CreateFlowLogs
              - ec2:DescribeFlowLogs
              - ec2:DeleteVpc
              - ec2:DeleteSubnet
              - ec2:DeleteInternetGateway
              - ec2:DetachInternetGateway
              - ec2:DeleteNatGateway
              - ec2:DeleteSecurityGroup
            Effect: Allow
            Resource: "*"
          - Effect: Allow
            Action:
              - elasticmapreduce:ListInstances
              - elasticmapreduce:DescribeCluster
              - elasticmapreduce:RunJobFlow
              - elasticmapreduce:TerminateJobFlows
              - elasticmapreduce:GetBlockPublicAccessConfiguration
              - elasticmapreduce:PutBlockPublicAccessConfiguration
              - elasticmapreduce:CreateSecurityConfiguration
              - elasticmapreduce:DescribeSecurityConfiguration
              - elasticmapreduce:ListInstanceGroups
              - elasticmapreduce:ListBootstrapActions
              - elasticmapreduce:AddTags
            Resource: "*"
          - Effect: Allow
            Action:
              - s3:PutBucketPolicy
              - s3:DeleteBucketPolicy
            Resource:
              - arn:aws:s3:::lifebit-user-data-*
          - Sid: ExplicitAllowCreateServiceLinkedRole
            Effect: Allow
            Action:
              - iam:CreateServiceLinkedRole
              - iam:AttachRolePolicy
              - iam:PutRolePolicy
            Resource: arn:aws:iam::*:role/aws-service-role/*
          - Effect: Allow
            Action:
              - ecs:DescribeContainerInstances
              - ecs:DescribeTasks
            Resource: "*"
          - Effect: Allow
            Action:
              - ecr:GetAuthorizationToken
              - ecr:BatchCheckLayerAvailability
              - ecr:GetDownloadUrlForLayer
              - ecr:GetRepositoryPolicy
              - ecr:DescribeRepositories
              - ecr:ListImages
              - ecr:DescribeImages
              - ecr:BatchGetImage
              - ecr:GetLifecyclePolicy
              - ecr:GetLifecyclePolicyPreview
              - ecr:ListTagsForResource
              - ecr:DescribeImageScanFindings
            Resource: "*"
          - Effect: Allow
            Action:
              - fsx:CreateFileSystem
              - fsx:DescribeFileSystems
              - fsx:DeleteFileSystem
              - fsx:CreateDataRepositoryTask
              - fsx:DescribeDataRepositoryTasks
              - fsx:TagResource
            Resource: "*"
          - Effect: Allow
            Action:
              - logs:CreateExportTask
              - logs:DescribeExportTasks
            Resource: "*"
          - Effect: Allow
            Action:
              - batch:DescribeComputeEnvironments
              - batch:CreateComputeEnvironment
              - batch:UpdateComputeEnvironment
              - batch:DeleteComputeEnvironment
              - batch:DescribeJobQueues
              - batch:RegisterJobDefinition
              - batch:CancelJob
              - batch:SubmitJob
              - batch:ListJobs
              - batch:TerminateJob
              - batch:DescribeJobs
              - batch:DescribeJobDefinitions
              - batch:CreateJobQueue
              - batch:UpdateJobQueue
              - batch:DeleteJobQueue
              - batch:TagResource
            Resource: "*"
          - Effect: Allow
            Action:
              - iam:CreatePolicy
              - iam:GetRole
              - iam:CreateRole
              - iam:GetPolicy
              - iam:GetPolicyVersion
              - iam:GetRolePolicy
              - iam:GetInstanceProfile
              - iam:CreateInstanceProfile
              - iam:CreateServiceLinkedRole
              - iam:ListRolePolicies
              - iam:ListAttachedRolePolicies
              - iam:AddRoleToInstanceProfile
            Resource: "*"
          - Sid: AllowCloudOSToGetDeleteDataAccessPolicies
            Effect: Allow
            Action:
              - iam:DeletePolicy
              - iam:CreatePolicyVersion
              - iam:DeletePolicyVersion
            Resource: arn:aws:iam::*:policy/lifebit-policy-*
          - Sid: AllowCloudOSToAttachDetachPoliciesForManagedRoles
            Effect: Allow
            Action:
              - iam:AttachRolePolicy
              - iam:DetachRolePolicy
            Resource:
              - arn:aws:iam::*:role/cloudos-*-job-role
              - arn:aws:iam::*:role/cloudos-*-session-role
              - arn:aws:iam::*:role/batch-*-instance-role
              - arn:aws:iam::*:role/cloudos-*-batch-instance-role
              - arn:aws:iam::*:role/emr-*-instance-role
              - arn:aws:iam::*:role/cloudos-*-emr-instance-role
              - arn:aws:iam::*:role/ecsInstanceRole
              - arn:aws:iam::*:role/AWSBatchServiceRole
              - arn:aws:iam::*:role/lifebit-cloudos-emr-service-role
              - arn:aws:iam::*:role/lifebit-cloudos-emr-instance-role
          - Effect: Allow
            Action:
              - iam:PassRole
              - sts:AssumeRole
            Resource:
              - arn:aws:iam::*:role/cloudos-*-job-role
              - arn:aws:iam::*:role/cloudos-*-session-role
              - arn:aws:iam::*:role/batch-*-instance-role
              - arn:aws:iam::*:role/cloudos-*-batch-instance-role
              - arn:aws:iam::*:role/emr-*-instance-role
              - arn:aws:iam::*:role/cloudos-*-emr-instance-role
              - arn:aws:iam::*:role/ecsInstanceRole
              - arn:aws:iam::*:role/AWSBatchServiceRole
              - arn:aws:iam::*:role/lifebit-cloudos-emr-service-role
              - arn:aws:iam::*:role/lifebit-cloudos-emr-instance-role
              - arn:aws:iam::*:role/aws-service-role/spotfleet.amazonaws.com/AWSServiceRoleForEC2SpotFleet
          - Effect: Allow
            Action:
              - sts:GetCallerIdentity
              - sts:GetSessionToken
              - sts:GetFederationToken
            Resource: "*"
          - Effect: Allow
            Action:
              - ssm:PutParameter
              - ssm:GetParameter
            Resource: "*"
          - Effect: Allow
            Action:
              - servicequotas:ListServiceQuotas
            Resource: "*"
          - Effect: Allow
            Action:
              - pricing:GetProducts
            Resource: "*"
          - Effect: Allow
            Action:
              - kms:CreateGrant
              - kms:RevokeGrant
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: "*"
          - Action:
              - ce:*
            Effect: Allow
            Resource: "*"
          - Action:
              - iam:PassRole
              - iam:AttachRolePolicy
            Effect: Allow
            Resource: "arn:aws:iam::*:role/vpc-publish-flow-logs"
      Roles:
        - !If [UseRole, !Ref LifebitWorkspaceRole, !Ref AWS::NoValue]
      Users:
        - !If [UseUser, !Ref LifebitWorkspaceUser, !Ref AWS::NoValue]

  LifebitWorkspacePolicy2:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName:
        !Join ["-", [!Ref IamRoleOrUserName, "LifebitWorkspacePolicy2"]]
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - ec2:DescribeTransitGateways
              - ec2:DescribeTransitGatewayVpcAttachments
              - ec2:CreateTransitGatewayVpcAttachment
              - ec2:ModifyTransitGatewayVpcAttachment
              - ec2:DeleteTransitGatewayVpcAttachment
              - ec2:GetTransitGatewayRouteTablePropagations
              - ec2:DescribeVpcEndpoints
              - ec2:DescribeVpcEndpointServices
              - ec2:DescribePrefixLists
              - ec2:CreateVpcEndpoint
              - ec2:ModifyVpcEndpoint
              - ec2:DeleteVpcEndpoints
              - ram:GetResourceShares
              - ram:ListResources
            Resource: "*"
          - Effect: Allow
            Action:
              - ec2:DescribeAccountAttributes
              - ec2:DescribeNetworkInterfaces
              - ec2:DeleteTags
              - ec2:DescribeTags
              - ec2:DescribeSecurityGroupRules
              - ec2:DescribeNetworkAcls
              - ec2:CreateNetworkAcl
              - ec2:CreateNetworkAclEntry
              - ec2:DeleteNetworkAcl
              - ec2:DeleteNetworkAclEntry
              - ec2:ReplaceNetworkAclEntry
              - ec2:ReplaceNetworkAclAssociation
              - ec2:DeleteRouteTable
              - ec2:DisassociateRouteTable
              - ec2:ReplaceRouteTableAssociation
              - ec2:DeleteRoute
              - ec2:ReplaceRoute
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:AuthorizeSecurityGroupEgress
              - ec2:ModifySecurityGroupRules
              - ec2:RevokeSecurityGroupIngress
              - ec2:RevokeSecurityGroupEgress
              - ec2:UpdateSecurityGroupRuleDescriptionsEgress
              - ec2:UpdateSecurityGroupRuleDescriptionsIngress
            Resource: "*"
          - Effect: Allow
            Action:
              - s3:AbortMultipartUpload
              - s3:CreateBucket
              - s3:DeleteBucket
              - s3:DeleteBucketPolicy
              - s3:DeleteObject
              - s3:GetBucketCors
              - s3:GetBucketLocation
              - s3:GetBucketPolicy
              - s3:GetBucketPolicyStatus
              - s3:GetBucketTagging
              - s3:GetBucketVersioning
              - s3:GetObject
              - s3:GetObjectAcl
              - s3:ListBucket
              - s3:ListMultipartUploadParts
              - s3:ListBucketVersions
              - s3:PutBucketCors
              - s3:GetLifecycleConfiguration
              - s3:PutBucketPolicy
              - s3:PutBucketPublicAccessBlock
              - s3:PutBucketTagging
              - s3:PutBucketVersioning
              - s3:PutObject
              - s3:PutLifecycleConfiguration
              - s3:PutEncryptionConfiguration
            Resource: "*"
      Roles:
        - !If [UseRole, !Ref LifebitWorkspaceRole, !Ref AWS::NoValue]
      Users:
        - !If [UseUser, !Ref LifebitWorkspaceUser, !Ref AWS::NoValue]

  LifebitWorkspaceRoleForAnalysesPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: ShouldCreateAndAllowInstanceRoles
    Properties:
      ManagedPolicyName:
        !Join [
          "-",
          [!Ref IamRoleOrUserName, "LifebitWorkspaceRoleForAnalysesPolicy"],
        ]
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - iam:PassRole
              - sts:assumeRole
            Resource:
              - !GetAtt [LifebitWorkspaceRole, Arn]
      Roles:
        - !Ref LifebitWorkspaceRole

  LifebitExternalNetworkPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: UseExternallyManagedNetwork
    Properties:
      ManagedPolicyName: !Sub 'lifebit-external-network-policy-${IamRoleOrUserName}'
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - ec2:AllocateAddress
              - ec2:CreateInternetGateway
              - ec2:AttachInternetGateway
              - ec2:CreateNatGateway
              - ec2:DescribeNatGateways 
              - ec2:CreateVpc
              - ec2:ModifyVpcAttribute
              - ec2:DescribeRouteTables
              - ec2:CreateRouteTable
              - ec2:CreateRoute
              - ec2:AssociateRouteTable
              - ec2:CreateSubnet
              - ec2:ModifySubnetAttribute
              - ec2:CreateSecurityGroup
              - ec2:CreateFlowLogs
              - ec2:DescribeFlowLogs
              - ec2:DeleteVpc
              - ec2:DeleteSubnet
              - ec2:DeleteInternetGateway
              - ec2:DetachInternetGateway
              - ec2:DeleteNatGateway
              - ec2:DeleteSecurityGroup
            Effect: Deny
            Resource: "*"
          - Action:
              - iam:PassRole
              - iam:AttachRolePolicy
            Effect: Deny
            Resource: "arn:aws:iam::*:role/vpc-publish-flow-logs"
      Roles:
        - !If [UseRole, !Ref LifebitWorkspaceRole, !Ref AWS::NoValue]
      Users:
        - !If [UseUser, !Ref LifebitWorkspaceUser, !Ref AWS::NoValue]

  LifebitBatchServiceRole:
    Type: AWS::IAM::Role
    Condition: UseCreateBatchServiceRole
    Properties:
      RoleName: AWSBatchServiceRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSBatchServiceRole
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - batch.amazonaws.com
            Action:
              - sts:AssumeRole

  LifebitEMRServiceRole:
    Type: AWS::IAM::Role
    Condition: UseCreateEMRServiceRole
    Properties:
      RoleName: lifebit-cloudos-emr-service-role
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonElasticMapReduceRole
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - elasticmapreduce.amazonaws.com
            Action:
              - sts:AssumeRole

  LifebitEMRInstancesRole:
    Type: AWS::IAM::Role
    Condition: ShouldCreateAndAllowInstanceRoles
    Properties:
      RoleName: lifebit-cloudos-emr-instance-role
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole

  LifebitEMRInstancesPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: ShouldCreateAndAllowInstanceRoles
    Properties:
      ManagedPolicyName: lifebit-cloudos-emr-instance-role-policy
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - ssm:UpdateInstanceInformation
              - ssmmessages:CreateControlChannel
              - ssmmessages:CreateDataChannel
              - ssmmessages:OpenControlChannel
              - ssmmessages:OpenDataChannel
              - kms:Decrypt
            Resource: "*"
          - Effect: Allow
            Action:
              - fsx:*
            Resource: "*"
          - Effect: Allow
            Action:
              - ecr:GetAuthorizationToken
              - ecr:BatchGetImage
              - ecr:GetDownloadUrlForLayer
            Resource: "*"
          - Effect: Allow
            Action:
              - s3:ListBucket
              - s3:ListBucketVersions
              - s3:ListBucketMultipartUploads
              - s3:GetObject
              - s3:GetObjectVersion
              - s3:GetObjectAcl
              - s3:GetObjectVersionAcl
              - s3:PutObject
              - s3:AbortMultipartUpload
              - s3:ListMultipartUploadParts
              - s3:PutObjectAcl
              - s3:PutObjectVersionAcl
              - s3:DeleteObject
              - s3:DeleteObjectVersion
            Resource: "*"
      Roles:
        - !Ref LifebitEMRInstancesRole

  LifebitEMRInstancesInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Condition: ShouldCreateAndAllowInstanceRoles
    Properties:
      Roles:
        - !Ref LifebitEMRInstancesRole
      InstanceProfileName: !Ref LifebitEMRInstancesRole

  LifebitBatchInstancesRole:
    Type: AWS::IAM::Role
    Condition: ShouldCreateAndAllowInstanceRoles
    Properties:
      RoleName: ecsInstanceRole
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole

  LifebitBatchInstancesPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: ShouldCreateAndAllowInstanceRoles
    Properties:
      ManagedPolicyName: ecsInstanceRole-policy
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - ecs:CreateCluster
              - ecs:DeregisterContainerInstance
              - ecs:DiscoverPollEndpoint
              - ecs:Poll
              - ecs:RegisterContainerInstance
              - ecs:StartTelemetrySession
              - ecs:UpdateContainerInstancesState
              - ecs:Submit*
              - logs:CreateLogStream
              - logs:PutLogEvents
            Resource: "*"
          - Effect: Allow
            Action:
              - ec2:DescribeTags
              - ec2:ModifyVolume
              - ec2:DescribeVolumes
              - ec2:DescribeVolumesModifications
            Resource: "*"
          - Effect: Allow
            Action:
              - ecr:GetAuthorizationToken
              - ecr:BatchCheckLayerAvailability
              - ecr:GetDownloadUrlForLayer
              - ecr:ListImages
              - ecr:DescribeRepositories
              - ecr:GetRepositoryPolicy
              - ecr:DescribeImages
              - ecr:GetLifecyclePolicy
              - ecr:GetLifecyclePolicyPreview
              - ecr:BatchGetImage
              - ecr:ListTagsForResource
              - ecr:DescribeImageScanFindings
            Resource: "*"
          - Effect: Allow
            Action:
              - ssm:getParameter
              - ssm:getParameters
            Resource: "*"
          - Effect: Allow
            Action:
              - ecs:TagResource
              - ssm:getParameters
            Resource: "*"
            Condition:
              StringEquals:
                "ecs:CreateAction":
                  ["CreateCluster", "RegisterContainerInstance"]
          - Effect: Allow
            Action:
              - ssm:UpdateInstanceInformation
              - ssmmessages:CreateControlChannel
              - ssmmessages:CreateDataChannel
              - ssmmessages:OpenControlChannel
              - ssmmessages:OpenDataChannel
              - kms:Decrypt
            Resource: "*"
          - Effect: Allow
            Action:
              - s3:AbortMultipartUpload
              - s3:ListBucket
              - s3:ListBucketVersions
              - s3:ListBucketMultipartUploads
              - s3:ListMultipartUploadParts
              - s3:GetObject
              - s3:GetObjectVersion
              - s3:GetObjectAcl
              - s3:GetObjectVersionAcl
              - s3:PutObject
              - s3:GetBucketLocation
            Resource: "*"
      Roles:
        - !Ref LifebitBatchInstancesRole

  LifebitBatchInstancesInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Condition: ShouldCreateAndAllowInstanceRoles
    Properties:
      Roles:
        - !Ref LifebitBatchInstancesRole
      InstanceProfileName: !Ref LifebitBatchInstancesRole

  AnalysesSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: CreateAnalysesSecurityGroup
    Properties:
      GroupName: cloudos-analyses-sg
      GroupDescription: Security group used by Lifebit for analyses.
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        - IpProtocol: '-1'
          CidrIp: 0.0.0.0/0

  FsxSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: CreateFsxSecurityGroup
    Properties:
      GroupName: lifebit-fsx
      GroupDescription: Security group used by Lifebit for fsx file systems.
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        - IpProtocol: '-1'
          CidrIp: 0.0.0.0/0

Outputs:
  RoleArn:
    Condition: UseRole
    Description: The ARN of the IAM role
    Value: !GetAtt [LifebitWorkspaceRole, Arn]
  UserArn:
    Condition: UseUser
    Description: The ARN of the IAM user
    Value: !GetAtt [LifebitWorkspaceUser, Arn]
  UserKey:
    Condition: UseUser
    Description: The AWS Key of the IAM user
    Value: !Ref LifebitWorkspaceUserKeys
  UserSecret:
    Condition: UseUser
    Description: The AWS secret of the IAM user can be found in the SSM.
    Value: !Ref LifebitWorkspaceUserSecret
  AnalysesSecurityGroupId:
    Condition: CreateAnalysesSecurityGroup
    Description: The ID of Analyses security group.
    Value: !GetAtt AnalysesSecurityGroup.GroupId
  AnalysesSecurityGroupVpcId:
    Condition: CreateAnalysesSecurityGroup
    Description: The VPC ID associated with analyses security group.
    Value: !GetAtt AnalysesSecurityGroup.VpcId
  FsxSecurityGroupId:
    Condition: CreateFsxSecurityGroup
    Description: The ID of the Fsx security group.
    Value: !GetAtt FsxSecurityGroup.GroupId
  FsxSecurityGroupVpcId:
    Condition: CreateFsxSecurityGroup
    Description: The VPC ID associated with fsx security group.
    Value: !GetAtt FsxSecurityGroup.VpcId
